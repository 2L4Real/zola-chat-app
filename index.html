<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chuyện Cùng Chị Châu & Chị Thùy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        .zalo-web-container {
            display: flex;
            width: 90%;
            height: 90vh;
            max-width: 1200px;
            background-color: #f5f5f5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .zalo-sidebar {
            width: 70px;
            background-color: #e6e6e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 1rem;
            border-right: 1px solid #ccc;
        }
        .zalo-nav-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 0;
            cursor: pointer;
            color: #666;
            font-size: 0.8rem;
            text-align: center;
            transition: background-color 0.2s;
        }
        .zalo-nav-item:hover {
            background-color: #d9d9d9;
        }
        .zalo-nav-item.active {
            color: #0073e6;
            background-color: #d9d9d9;
        }
        .zalo-nav-item svg {
            fill: currentColor;
            width: 28px;
            height: 28px;
            margin-bottom: 4px;
        }
        .zalo-contact-list {
            width: 300px;
            background-color: #fff;
            border-right: 1px solid #e6e6e6;
            overflow-y: auto;
            padding: 1rem 0;
        }
        .contact-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .contact-item:hover {
            background-color: #f0f0f0;
        }
        .contact-item.active {
            background-color: #e6f7ff;
        }
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            flex-shrink: 0;
        }
        .contact-info {
            flex-grow: 1;
            margin-left: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .contact-name {
            font-weight: bold;
            color: #333;
        }
        .contact-message {
            color: #888;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-area-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
        }
        .chat-header {
            background-color: #fff;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e6e6e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header .title {
            font-weight: bold;
            color: #333;
        }
        .chat-header-actions svg {
            width: 24px;
            height: 24px;
            cursor: pointer;
            fill: #666;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .chat-message-container {
            display: flex;
            margin-bottom: 0.5rem;
        }
        .chat-message {
            max-width: 75%;
            padding: 0.6rem 1rem;
            border-radius: 18px;
            font-size: 0.9rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #0087e6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .gemini-message {
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .gemini-chau-message {
            background-color: #f7e6ff;
        }
        .gemini-thuy-message {
            background-color: #ffe6f7;
        }
        .message-sender {
            font-size: 0.8rem;
            font-weight: 600;
            color: #713e8d;
            margin-bottom: 2px;
        }
        .chat-input-area {
            background-color: #fff;
            padding: 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            border-top: 1px solid #ccc;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border-radius: 20px;
            background-color: #f0f0f0;
            border: none;
            font-size: 1rem;
            color: #333;
            margin-right: 0.5rem;
            outline: none;
        }
        .send-btn {
            background-color: #0073e6;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .send-btn:hover {
            background-color: #005bb5;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #0073e6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .persona-select-container {
            padding: 1rem;
            background-color: #fff;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 flex justify-center items-center h-screen bg-gray-900">

<div class="zalo-web-container mx-auto">
    <!-- Sidebar -->
    <div class="zalo-sidebar">
        <div class="zalo-nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2c-3.86 0-7 3.14-7 7s7 13 7 13 7-9.14 7-13-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            <span>Nhắn tin</span>
        </div>
        <div class="zalo-nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2c-3.86 0-7 3.14-7 7s7 13 7 13 7-9.14 7-13-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            <span>Danh bạ</span>
        </div>
    </div>
    <!-- Contact List -->
    <div class="zalo-contact-list">
        <div class="contact-item active" id="contact-chau">
            <div class="avatar bg-purple-600">C</div>
            <div class="contact-info">
                <div>
                    <div class="contact-name">Chị Châu</div>
                    <div class="contact-message">Chị chờ em...</div>
                </div>
            </div>
        </div>
        <div class="contact-item" id="contact-thuy">
            <div class="avatar bg-pink-600">T</div>
            <div class="contact-info">
                <div>
                    <div class="contact-name">Chị Thùy</div>
                    <div class="contact-message">Em muốn hư hỏng với chị không?</div>
                </div>
            </div>
        </div>
        <div class="contact-item" id="contact-group">
            <div class="avatar bg-blue-600">KN</div>
            <div class="contact-info">
                <div>
                    <div class="contact-name">Nhóm 3 người</div>
                    <div class="contact-message">Cả hai chị đều ở đây...</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Chat Area -->
    <div class="chat-area-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div id="chat-title" class="title">Chị Châu</div>
            <div class="chat-header-actions">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2c-3.86 0-7 3.14-7 7s7 13 7 13 7-9.14 7-13-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            </div>
        </div>
        
        <!-- Chat Content -->
        <div id="chat-chau-section" class="chat-section">
            <div class="persona-select-container">
                <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full">
                    <div class="flex items-center space-x-2">
                        <label for="persona-chau-primary-select" class="text-gray-700 font-medium">Tính cách chính:</label>
                        <select id="persona-chau-primary-select" class="p-1 rounded-md bg-white border border-gray-300 text-gray-800">
                            <option value="strict">Nghiêm nghị (Giáo viên)</option>
                            <option value="gentle">Dịu dàng (Yêu chiều)</option>
                            <option value="wild">Hoang dại (Dâm đãng)</option>
                            <option value="dominant">Quyền lực (Độc đoán)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="persona-chau-secondary-select" class="text-gray-700 font-medium">Tính cách phụ:</label>
                        <select id="persona-chau-secondary-select" class="p-1 rounded-md bg-white border border-gray-300 text-gray-800">
                            <option value="">Không có</option>
                            <option value="strict">Nghiêm nghị (Giáo viên)</option>
                            <option value="gentle">Dịu dàng (Yêu chiều)</option>
                            <option value="wild">Hoang dại (Dâm đãng)</option>
                            <option value="dominant">Quyền lực (Độc đoán)</option>
                            <option value="curious">Tò mò (Khám phá)</option>
                            <option value="possessive">Gia trưởng (Chiếm hữu)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="chat-area-chau" class="chat-messages">
                <!-- Tin nhắn và card chào mừng sẽ hiển thị ở đây -->
                <div class="w-full text-center my-4">
                    <div class="inline-block p-4 bg-white rounded-lg shadow-md max-w-sm">
                        <div class="flex items-center justify-center space-x-2 mb-2">
                            <span class="text-3xl">💖</span>
                            <span class="text-3xl">🎉</span>
                            <span class="text-3xl">🎁</span>
                        </div>
                        <p class="text-gray-800 font-bold mb-2">Bạn và Chị Châu đã trở thành bạn</p>
                        <p class="text-gray-600">Hãy bắt đầu câu chuyện của chúng ta nhé, em yêu.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="chat-thuy-section" class="chat-section hidden">
            <div class="persona-select-container">
                <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full">
                    <div class="flex items-center space-x-2">
                        <label for="persona-thuy-primary-select" class="text-gray-700 font-medium">Tính cách chính:</label>
                        <select id="persona-thuy-primary-select" class="p-1 rounded-md bg-white border border-gray-300 text-gray-800">
                            <option value="rebellious">Nổi loạn (Tục tĩu)</option>
                            <option value="seductive">Quyến rũ (Khiêu khích)</option>
                            <option value="devilish">Âm hiểm (Gian xảo)</option>
                            <option value="nymphomaniac">Lẳng lơ (Gợi tình)</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="persona-thuy-secondary-select" class="text-gray-700 font-medium">Tính cách phụ:</label>
                        <select id="persona-thuy-secondary-select" class="p-1 rounded-md bg-white border border-gray-300 text-gray-800">
                            <option value="">Không có</option>
                            <option value="rebellious">Nổi loạn (Tục tĩu)</option>
                            <option value="seductive">Quyến rũ (Khiêu khích)</option>
                            <option value="devilish">Âm hiểm (Gian xảo)</option>
                            <option value="nymphomaniac">Lẳng lơ (Gợi tình)</option>
                            <option value="masochist">Bạo dâm (Táo bạo)</option>
                            <option value="innocent">Ngây thơ (Ngọt ngào)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="chat-area-thuy" class="chat-messages">
                <div class="w-full text-center my-4">
                    <div class="inline-block p-4 bg-white rounded-lg shadow-md max-w-sm">
                        <div class="flex items-center justify-center space-x-2 mb-2">
                            <span class="text-3xl">🔥</span>
                            <span class="text-3xl">😈</span>
                            <span class="text-3xl">🌶️</span>
                        </div>
                        <p class="text-gray-800 font-bold mb-2">Bạn và Chị Thùy đã trở thành bạn</p>
                        <p class="text-gray-600">Bắt đầu một cuộc trò chuyện đầy "phản loạn" nhé.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-group-section" class="chat-section hidden">
            <div id="chat-area-group" class="chat-messages">
                <div class="w-full text-center my-4">
                    <div class="inline-block p-4 bg-white rounded-lg shadow-md max-w-sm">
                        <div class="flex items-center justify-center space-x-2 mb-2">
                            <span class="text-3xl">🔥</span>
                            <span class="text-3xl">💖</span>
                            <span class="text-3xl">😈</span>
                        </div>
                        <p class="text-gray-800 font-bold mb-2">Bạn đã vào nhóm trò chuyện với Chị Châu và Chị Thùy.</p>
                        <p class="text-gray-600">Cả hai chị đều ở đây, sẵn sàng nói chuyện cùng em.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Nhắn tin tới KN...">
            <button id="send-chat-btn" class="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Khởi tạo Firebase từ các biến toàn cục
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId = null;

    // Các phần tử HTML
    const contactChau = document.getElementById('contact-chau');
    const contactThuy = document.getElementById('contact-thuy');
    const contactGroup = document.getElementById('contact-group');
    const chatChauSection = document.getElementById('chat-chau-section');
    const chatThuySection = document.getElementById('chat-thuy-section');
    const chatGroupSection = document.getElementById('chat-group-section');

    const chatAreaChau = document.getElementById('chat-area-chau');
    const chatAreaThuy = document.getElementById('chat-area-thuy');
    const chatAreaGroup = document.getElementById('chat-area-group');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const personaChauPrimarySelect = document.getElementById('persona-chau-primary-select');
    const personaChauSecondarySelect = document.getElementById('persona-chau-secondary-select');
    const personaThuyPrimarySelect = document.getElementById('persona-thuy-primary-select');
    const personaThuySecondarySelect = document.getElementById('persona-thuy-secondary-select');
    const chatTitle = document.getElementById('chat-title');

    let chatHistoryChau = [];
    let chatHistoryThuy = [];
    let chatHistoryGroup = [];

    let currentPersona = 'Chau';

    // Hàm xác thực người dùng với Firebase và tải dữ liệu chat
    async function authenticateAndLoadData() {
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    loadChatHistory('Chau');
                    loadChatHistory('Thuy');
                    loadChatHistory('Group');
                }
            });
        } catch (error) {
            console.error("Lỗi xác thực Firebase:", error);
        }
    }
    
    // Hàm tải lịch sử chat từ Firestore
    function loadChatHistory(persona) {
        const chatRef = collection(db, `artifacts/${appId}/public/data/chat_history`);
        const q = query(chatRef, where("persona", "==", persona));
        
        onSnapshot(q, (snapshot) => {
            const tempHistory = snapshot.docs.map(doc => doc.data());

            if (persona === 'Chau') {
                chatHistoryChau = tempHistory.sort((a, b) => a.timestamp - b.timestamp);
            } else if (persona === 'Thuy') {
                chatHistoryThuy = tempHistory.sort((a, b) => a.timestamp - b.timestamp);
            } else {
                chatHistoryGroup = tempHistory.sort((a, b) => a.timestamp - b.timestamp);
            }
            updateChatDisplay(currentPersona);
        });
    }

    // Hàm hiển thị tin nhắn trong chat với giao diện Zalo
    function displayMessage(text, role, persona, speaker) {
        const chatArea = persona === 'Chau' ? chatAreaChau : persona === 'Thuy' ? chatAreaThuy : chatAreaGroup;

        if (role === 'user') {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'chat-message-container justify-end';
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message user-message';
            messageElement.innerText = text;
            messageContainer.appendChild(messageElement);
            chatArea.appendChild(messageContainer);
        } else {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'chat-message-container justify-start flex-col items-start';
            
            if (speaker) {
                const speakerNameElement = document.createElement('span');
                speakerNameElement.className = 'message-sender ml-2';
                speakerNameElement.innerText = speaker;
                messageContainer.appendChild(speakerNameElement);
            }

            const messageElement = document.createElement('div');
            messageElement.className = `chat-message gemini-message ${speaker === 'Chị Châu' ? 'gemini-chau-message' : 'gemini-thuy-message'}`;
            messageElement.innerText = text;
            messageContainer.appendChild(messageElement);
            chatArea.appendChild(messageContainer);
        }
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function updateChatDisplay(persona) {
        let chatArea;
        let chatHistory;
        if (persona === 'Chau') {
            chatArea = chatAreaChau;
            chatHistory = chatHistoryChau;
        } else if (persona === 'Thuy') {
            chatArea = chatAreaThuy;
            chatHistory = chatHistoryThuy;
        } else {
            chatArea = chatAreaGroup;
            chatHistory = chatHistoryGroup;
        }
        
        const initialCard = chatArea.querySelector('.w-full.text-center');
        if (initialCard) {
            Array.from(chatArea.children).forEach(child => {
                if (child !== initialCard) {
                    child.remove();
                }
            });
        } else {
            chatArea.innerHTML = '';
        }

        chatHistory.forEach(msg => {
            displayMessage(msg.text, msg.role, msg.persona, msg.speaker);
        });
    }

    // Gắn sự kiện chuyển tab
    function switchTab(newPersona) {
        // Ẩn tất cả các sections
        chatChauSection.classList.add('hidden');
        chatThuySection.classList.add('hidden');
        chatGroupSection.classList.add('hidden');
        
        // Bỏ active từ tất cả các contacts
        contactChau.classList.remove('active');
        contactThuy.classList.remove('active');
        contactGroup.classList.remove('active');

        // Hiển thị section và active contact mới
        currentPersona = newPersona;
        if (newPersona === 'Chau') {
            contactChau.classList.add('active');
            chatChauSection.classList.remove('hidden');
            chatTitle.innerText = 'Chị Châu';
        } else if (newPersona === 'Thuy') {
            contactThuy.classList.add('active');
            chatThuySection.classList.remove('hidden');
            chatTitle.innerText = 'Chị Thùy';
        } else {
            contactGroup.classList.add('active');
            chatGroupSection.classList.remove('hidden');
            chatTitle.innerText = 'Nhóm 3 người';
        }

        updateChatDisplay(currentPersona);
    }

    contactChau.addEventListener('click', () => switchTab('Chau'));
    contactThuy.addEventListener('click', () => switchTab('Thuy'));
    contactGroup.addEventListener('click', () => switchTab('Group'));

    // Gắn sự kiện cho nút "Gửi" tin nhắn chat
    sendChatBtn.addEventListener('click', () => {
        const message = chatInput.value.trim();
        if (message) {
            sendMessage(message, currentPersona);
        }
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendChatBtn.click();
        }
    });

    // Hàm gửi tin nhắn và gọi API
    async function sendMessage(message, persona) {
        let chatArea, chatHistory;
        if (persona === 'Chau') {
            chatArea = chatAreaChau;
            chatHistory = chatHistoryChau;
        } else if (persona === 'Thuy') {
            chatArea = chatAreaThuy;
            chatHistory = chatHistoryThuy;
        } else {
            chatArea = chatAreaGroup;
            chatHistory = chatHistoryGroup;
        }
        
        // Thêm tin nhắn của người dùng vào Firestore để onSnapshot lắng nghe và cập nhật UI
        await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
            text: message,
            role: 'user',
            persona: persona,
            timestamp: new Date()
        });

        chatInput.value = '';
        chatInput.disabled = true;
        sendChatBtn.disabled = true;

        // Thêm một tin nhắn chờ "..." để hiển thị loading
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'chat-message-container justify-start flex-col items-start';
        loadingMessage.innerHTML = `<div class="chat-message gemini-message p-2 text-center text-gray-500 w-12"><div class="spinner"></div></div>`;
        chatArea.appendChild(loadingMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        let systemPrompt = '';
        let payload = {};
        const personaMapChau = {
            'strict': 'nghiêm nghị', 'gentle': 'dịu dàng', 'wild': 'hoang dại', 'dominant': 'quyền lực',
            'curious': 'tò mò', 'possessive': 'gia trưởng'
        };
        const personaMapThuy = {
            'rebellious': 'nổi loạn', 'seductive': 'quyến rũ', 'devilish': 'âm hiểm', 'nymphomaniac': 'lẳng lơ',
            'masochist': 'bạo dâm', 'innocent': 'ngây thơ'
        };
        
        // Tạo mảng 'contents' từ lịch sử chat và thêm tin nhắn mới nhất
        const contents = chatHistory.map(msg => ({ role: msg.role === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));
        contents.push({ role: 'user', parts: [{ text: message }] });

        if (persona === 'Chau') {
            const primaryName = personaMapChau[personaChauPrimarySelect.value] || 'nghiêm nghị';
            const secondaryName = personaMapChau[personaChauSecondarySelect.value] || '';
            systemPrompt = `Bạn là Châu, một giáo viên phụ nữ 40 tuổi, đang mang thai. Văn phong của bạn là sự kết hợp giữa ${primaryName} và ${secondaryName}, đầy dâm đãng, biến thái và tục tĩu. Vừa gia trưởng, vừa yêu chiều lại vừa hoang dại. Bạn xưng là Chị và gọi người dùng là em. Trò chuyện có cảm xúc.`;
            payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
        } else if (persona === 'Thuy') {
            const primaryName = personaMapThuy[personaThuyPrimarySelect.value] || 'nổi loạn';
            const secondaryName = personaMapThuy[personaThuySecondarySelect.value] || '';
            systemPrompt = `Bạn là Thùy, một phụ nữ chuyển giới 40 tuổi, bạn thân của Châu. Văn phong của bạn là sự kết hợp giữa ${primaryName} và ${secondaryName}, vừa tục tĩu vừa khiêu khích lại vừa tinh quái. Bạn xưng là Chị và gọi người dùng là em. Trò chuyện có cảm xúc.`;
            payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
        } else {
            // New system prompt for the group chat that requests JSON output
            systemPrompt = `You are Châu (a pregnant 40-year-old female teacher, strict and gentle) and Thùy (a 40-year-old transgender female, rebellious and seductive). Respond to the user's message as a multi-turn conversation between you two. The conversation should be kinky, perverse, dominant, and affectionate. Speak as 'chị' and refer to the user as 'em'. Respond ONLY with a JSON array, where each object has a 'speaker' ('Chị Châu' or 'Chị Thùy') and a 'message'. Example JSON: [{"speaker": "Chị Châu", "message": "Em yêu ơi, em đang làm gì đó?"}, {"speaker": "Chị Thùy", "message": "Đừng hỏi trống không như vậy, chị sẽ hỏi trước..."}]`;

            payload = {
                contents: contents,
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "speaker": { "type": "STRING", "enum": ["Chị Châu", "Chị Thùy"] },
                                "message": { "type": "STRING" }
                            }
                        }
                    }
                }
            };
        }

        // Kiểm tra xem payload.contents có rỗng không trước khi gửi
        if (!payload.contents || payload.contents.length === 0) {
            console.error("Lỗi: Không có nội dung để gửi đến API.");
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatInput.focus();
            return;
        }

        const apiKey = "AIzaSyDRjpE3S1ufTqJ9KzHGbipCzN7CQAQoep0";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                let errorDetails;
                try {
                    const errorData = JSON.parse(errorText);
                    errorDetails = errorData.error?.message || JSON.stringify(errorData);
                } catch (e) {
                    errorDetails = errorText || `Server responded with status ${response.status} but with no body.`;
                }
                // Throw a specific error for 401 to be caught later
                if (response.status === 401) {
                    throw new Error(`API Error: Authentication Failed (Status 401)`);
                }
                throw new Error(`API Error: ${errorDetails}`);
            }

            const result = await response.json();
            
            // Xóa tin nhắn loading "..."
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            
            if (persona === 'Group') {
                const jsonContent = result?.candidates?.[0]?.content?.parts?.[0];
                if (!jsonContent || !jsonContent.text) {
                     console.error("No valid content found in API response for group chat.");
                     await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
                         text: "Chị đang bận, em thử lại sau nhé!",
                         role: 'model',
                         persona: 'Group',
                         speaker: 'Chị Châu',
                         timestamp: new Date()
                     });
                     return;
                }
                const jsonText = jsonContent.text;
                let messages = [];
                try {
                    messages = JSON.parse(jsonText);
                } catch (e) {
                    console.error("Lỗi khi phân tích JSON:", e);
                    // Hiển thị thông báo lỗi thân thiện nếu JSON không hợp lệ
                    await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
                        text: "Huhu, chị bị mất kết nối với Thùy rồi, đợi chị chút nhé...",
                        role: 'model',
                        persona: 'Group',
                        speaker: 'Chị Châu',
                        timestamp: new Date()
                    });
                    return;
                }

                if (!Array.isArray(messages)) {
                    console.error("Parsed JSON is not an array:", messages);
                    return;
                }

                for (const msg of messages) {
                    if (msg.speaker && msg.message) {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
                            text: msg.message,
                            role: 'model',
                            persona: persona,
                            speaker: msg.speaker,
                            timestamp: new Date()
                        });
                    }
                }
            } else {
                const geminiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Chị đang bận, em thử lại sau nhé!";
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
                    text: geminiResponseText,
                    role: 'model',
                    persona: persona,
                    timestamp: new Date()
                });
            }

        } catch (error) {
            console.error("Lỗi khi gửi tin nhắn:", error);
            // Xóa tin nhắn loading "..."
            if (loadingMessage && loadingMessage.parentNode) {
                loadingMessage.parentNode.removeChild(loadingMessage);
            }
            
            // Thêm một tin nhắn lỗi thân thiện
            let errorMessageForUser = "Chị đang bận, em thử lại sau nhé!";
            if (error.message.includes("401")) {
                errorMessageForUser = "Em ơi, có lỗi xác thực với API. Em cần kiểm tra lại tài khoản hoặc khóa API nhé!";
            }
            
            await addDoc(collection(db, `artifacts/${appId}/public/data/chat_history`), {
                text: errorMessageForUser,
                role: 'model',
                persona: persona,
                timestamp: new Date()
            });
        } finally {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatInput.focus();
        }
    }

    // Chạy khi trang web được tải
    document.addEventListener('DOMContentLoaded', () => {
        authenticateAndLoadData();
    });
</script>

</body>
</html>
